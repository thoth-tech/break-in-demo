<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome file</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h3 id="building-graphical-applications-with-splashkit">Building Graphical Applications With Splashkit</h3>
<hr>
<h1 id="breakin-a-game-development-tutorial">BreakIn: A Game Development Tutorial</h1>
<p><img src="tutorial_assets/title.gif" alt="BreakIn"></p>
<h4 id="table-of-contents">Table of Contents</h4>
<ul>
<li><strong><a href="#introduction">Introduction</a></strong>
<ul>
<li>Overview of BreakIn</li>
<li>Setting up the development environment</li>
</ul>
</li>
<li><strong><a href="#the-event-loop">The Event Loop</a></strong>
<ul>
<li>Understanding the main game loop</li>
<li>Event handling and game flow</li>
</ul>
</li>
<li><strong><a href="#detour---utility-functions">Detour - Utility Functions</a></strong>
<ul>
<li>Implementing utility functions for game development</li>
<li>Rolling our own XOR PRNG</li>
</ul>
</li>
<li><strong><a href="#setting-up-global-constants">Setting Up Global Constants</a></strong>
<ul>
<li>Defining constants for screen dimensions and gameplay settings</li>
<li>Organizing global constants for easy access and modification</li>
</ul>
</li>
<li><strong><a href="#global-state-management">Global State Management</a></strong>
<ul>
<li>Designing the global state structure</li>
<li>Managing game-wide states and settings</li>
</ul>
</li>
<li><strong><a href="#basic-game-entities">Basic Game Entities</a></strong>
<ul>
<li>Defining instance structures for game objects</li>
<li>Abstracting common functionalities</li>
</ul>
</li>
<li><strong><a href="#initialising-game-entities">Initialising Game Entities</a></strong>
<ul>
<li>Creating instances of game objects</li>
<li>Initialising states for gameplay</li>
</ul>
</li>
<li><strong><a href="#terrain-grid-and-block-positioning">Terrain Grid and Block Positioning</a></strong>
<ul>
<li>Implementing the grid system for blocks</li>
<li>Storing block positions within the grid</li>
</ul>
</li>
<li><strong><a href="#populating-the-grid">Populating the Grid</a></strong>
<ul>
<li>Creating a function to generate a fully populated grid</li>
</ul>
</li>
<li><strong><a href="#updating-state-and-looping-back">Updating State and Looping Back</a></strong>
<ul>
<li>Handling state changes during gameplay</li>
<li>Integrating state updates with the event loop</li>
<li>Implementing update functions for game entities</li>
</ul>
</li>
<li><strong><a href="#drawing-the-game">Drawing the Game</a></strong>
<ul>
<li>Implementing draw functions for game entities</li>
<li>Rendering the game state on the screen</li>
</ul>
</li>
<li><strong><a href="#making-the-terrain-endless">Making the Terrain Endless</a></strong>
<ul>
<li>Implementing DFS culling to remove disconnected blocks</li>
<li>Adding velocity to blocks for smooth transition</li>
</ul>
</li>
<li><strong><a href="#particles">Particles</a></strong>
<ul>
<li>Creating a particle type</li>
<li>Implementing particle updates and drawing</li>
<li>Spawning particles on block destruction</li>
</ul>
</li>
<li><strong><a href="#juice-particles-and-color">Juice, Particles, and Color</a></strong>
<ul>
<li>Enhancing the game with visual effects</li>
<li>Adding particle systems for dynamic interactions</li>
<li>Incorporating color and graphics enhancements</li>
</ul>
</li>
<li><strong><a href="#conclusion">Conclusion</a></strong>
<ul>
<li>Recap and next steps for game development</li>
</ul>
</li>
</ul>
<hr>
<h1 id="introduction">Introduction</h1>
<p>BreakIn is a game development project that explores basic game design patterns and implementations, walking you through building something that combines classic arcade gameplay with some procedural generation and programmatic drawing techniques. This tutorial will guide you through the development process, leveraging SplashKit as the graphics engine.</p>
<p>Our initial goal is to create a simple breakout-style game where the player controls a paddle to bounce a ball and break <em><strong>an endless stream</strong></em> of blocks. We will start with the core game loop, event handling, and state management, then gradually introduce more complex features like physics, terrain generation, and visual effects.</p>
<p><strong>note:</strong> This tutorial uses a combination of imperative and functional / declarative patterns to encapsulate and inform functionality, this is a personal choice by me based on both the implementation language and my general distaste for object oriented design patterns. That said, the concepts and broad implementation patterns covered from here on out can easily be applied to an object oriented approach.</p>
<h2 id="setting-up-the-development-environment">Setting up the development environment</h2>
<p>To begin, ensure you have the necessary tools and libraries installed:</p>
<ol>
<li>
<p><strong>SplashKit SDK:</strong> Download and install the SplashKit SDK from <a href="https://www.splashkit.io/">the official website</a>.</p>
</li>
<li>
<p><strong>C++ Compiler:</strong> Ensure you have a C++ compiler set up. For Windows, you can use MinGW or Visual Studio. For macOS and Linux, GCC or Clang are good options.</p>
</li>
<li>
<p><strong>IDE:</strong> While not mandatory, an Integrated Development Environment (IDE) like Visual Studio Code or CLion (Jetbrains) can streamline your development process.</p>
</li>
</ol>
<p>Once you have the environment set up, initialise a new Spashkit project:</p>
<p>Make the project folder and navigate to it:</p>
<pre class=" language-bash"><code class="prism  language-bash"><span class="token function">mkdir</span> BreakIn  
<span class="token function">cd</span> BreakIn  
</code></pre>
<p>Then initialise a new Splashkit project:</p>
<pre class=" language-bash"><code class="prism  language-bash">skm new c++  
</code></pre>
<p>Open the project in your IDE.</p>
<h1 id="the-event-loop">The Event Loop</h1>
<p>At the heart of BreakIn—and indeed, any game development project—lies the event loop, a perpetual cycle that processes input, updates game state, and renders the game frame by frame. This cyclical nature is how graphical applications implement a continuous experience, reflecting real-time interaction. Utilising SplashKit, we will delve into the functionality exposed by the event loop, unraveling its components and demonstrating how it functions as the game’s central nervous system.</p>
<h2 id="understanding-the-main-game-loop">Understanding the Main Game Loop</h2>
<p>The main game loop is a fundamental paradigm that drives game execution. It encompasses three critical stages: processing input, updating game state, and rendering.</p>
<ul>
<li><strong>Input</strong>: Capturing and interpreting player actions as meaningful game commands.</li>
<li><strong>Update</strong>: Adjusting the game state in response to input, time passage, and internal logic.</li>
<li><strong>Render</strong>: Drawing the visual representation of the current game state onto the screen.</li>
</ul>
<p>Each iteration of the loop is a snapshot, a single frame in the game’s lifespan. As such, it must be both efficient and comprehensive to maintain the illusion of continuity.</p>
<p>Here’s a diagram demonstrating a single iteration of the game loop / state management flow we are going ot implement; it demonstrates distinct separation of concerns around management of discrete state and rendering patterns:</p>
<p><img src="tutorial_assets/state_diagram.png" alt="game loop"></p>
<h2 id="event-handling-and-game-flow">Event Handling and Game Flow</h2>
<p>SplashKit simplifies event management, providing a structured approach to handling user input and system events. <strong>note:</strong> The comments in the code block below are for the purposes of the tutorial.</p>
<p><strong>program.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token comment">// import  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"splashkit.h"</span>  </span>
  
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token punctuation">{</span>  
    <span class="token comment">// Open the window to begin the game  </span>
    <span class="token function">open_window</span><span class="token punctuation">(</span><span class="token string">"BreakIn"</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">hide_mouse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hide mouse while cursor is over game window  </span>
  
    <span class="token comment">// Main game loop: continues to run until the window is closed  </span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">quit_requested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
        <span class="token comment">// Ingest input from peripheral devices  </span>
        <span class="token function">process_events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// Update game state values (we will implement this routine ourselves)  </span>
        <span class="token function">update_global_state</span><span class="token punctuation">(</span>gamestate<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// Draw to frame buffer (we will also implement this)  </span>
        <span class="token function">draw_global_state</span><span class="token punctuation">(</span>gamestate<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// Refresh at target frames per second  </span>
        <span class="token function">refresh_screen</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token comment">// Close the game window and clean up resources  </span>
    <span class="token function">close_window</span><span class="token punctuation">(</span><span class="token string">"BreakIn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>Within this loop, you will integrate logic to react to keyboard strokes, mouse movements, and other player inputs. <code>process_events</code> function serves as the dispatcher, funneling input in to scope.<br>
<code>update_game_state</code> mutates the game’s state, readying it for the next frame’s visual portrayal.<br>
<code>draw_game</code> will invoke functions to generate the next frame of the game.<br>
<code>refresh_screen</code> concludes the cycle by presenting the updated state to the player.</p>
<hr>
<p>This section establishes the importance of the event loop and provides a foundation against which we can start designing implementations. In the following sections, we will populate this loop with the functionality described above.</p>
<p>We will explore creating a structured and easily manageable state system, incorporating conventions which enforce composable and extendable code. We’ll examine how to encapsulate the game state, manage transitions, and effectively control game flow.</p>
<p>This will set the foundation for the more intricate features of your game and ensure that all components work cohesively to create a seamless gaming and development experience.</p>
<h1 id="detour---utility-functions">Detour - Utility Functions</h1>
<p>Before diving into the core game development concepts, we’ll quickly implement a couple of helpful functions that we’ll use later, as well as our own PRNG type which is the only object with member functions we’ll implement directly in this tutorial. The reason for this is that a PRNG is one of the only abstractions where I can confidently say encapsulation of functionality and state is the best design approach (it needs to be portable, expose a consistent interface, and maintain its own state throughout the application lifetime). The rest of our functionality will be implemented as functions which take in and return data structures, this is to keep our code as simple and composable as possible.</p>
<h2 id="utility-functions-in-breakin">Utility Functions in BreakIn</h2>
<h3 id="xorshift-prng">XORShift PRNG</h3>
<p><strong>XOR.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">pragma</span> once  </span>
  
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdint&gt;</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;algorithm&gt;</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdexcept&gt;</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;limits&gt;</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span>  </span>
  
<span class="token comment">/**  
 * @brief Simple random number generator based on XOR shift algorithm.  
 */</span>  
<span class="token keyword">struct</span> XOR <span class="token punctuation">{</span>  
    <span class="token comment">/**  
     * @brief Constructor for XOR random number generator.  
     * @param initialSeed The initial seed value for the generator.  
     */</span>  
    <span class="token function">XOR</span><span class="token punctuation">(</span>uint32_t initialSeed <span class="token operator">=</span> <span class="token number">0x77777777</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token comment">/**  
     * @brief Generates a random integer in the range [min, max].  
     * @param min The minimum value of the range.  
     * @param max The maximum value of the range.  
     * @return A random integer in the specified range.  
     */</span>  
    <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">randomInt</span><span class="token punctuation">(</span><span class="token keyword">int</span> min<span class="token punctuation">,</span> <span class="token keyword">int</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token comment">/**  
     * @brief Generates a random float in the range [min, max].  
     * @param min The minimum value of the range.  
     * @param max The maximum value of the range.  
     * @return A random float in the specified range.  
     */</span>  
    <span class="token keyword">inline</span> <span class="token keyword">float</span> <span class="token function">randomFloat</span><span class="token punctuation">(</span><span class="token keyword">float</span> min <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token keyword">float</span> max <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token comment">/**  
     * @brief Generates a boolean value with a given probability of being true.  
     * @param probability The probability of returning true (0.0f to 1.0f).  
     * @return true with the specified probability, false otherwise.  
     */</span>  
    <span class="token keyword">inline</span> <span class="token keyword">bool</span> <span class="token function">chance</span><span class="token punctuation">(</span><span class="token keyword">float</span> probability <span class="token operator">=</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token comment">/**  
     * @brief Chooses a random element from a vector.  
     * @param vec The vector from which to choose.  
     * @return A random element from the vector.  
     * @throws std::invalid_argument if the vector is empty.  
     */</span>  
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">&gt;</span>  
    <span class="token keyword">inline</span> T <span class="token function">choose</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> vec<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token comment">/**  
     * @brief Chooses a random element from an array.  
     * @param arr The array from which to choose.  
     * @return A random element from the array.  
     */</span>  
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token punctuation">,</span> size_t N<span class="token operator">&gt;</span>  
    <span class="token keyword">inline</span> T <span class="token function">choose</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token function">T</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>arr<span class="token punctuation">)</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token keyword">private</span><span class="token operator">:</span>  
    <span class="token comment">/**  
     * @brief Generates the next random number in the sequence.  
     * @return The next random number.  
     */</span>  
    <span class="token keyword">inline</span> uint32_t <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    uint32_t seed<span class="token punctuation">;</span> <span class="token comment">///&lt; The current seed value for the generator.  </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
  
<span class="token comment">// Inline function definitions  </span>
  
<span class="token keyword">inline</span> XOR<span class="token operator">::</span><span class="token function">XOR</span><span class="token punctuation">(</span>uint32_t initialSeed<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">seed</span><span class="token punctuation">(</span>initialSeed<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  
  
<span class="token keyword">inline</span> uint32_t XOR<span class="token operator">::</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    seed <span class="token operator">^</span><span class="token operator">=</span> seed <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">;</span>  
    seed <span class="token operator">^</span><span class="token operator">=</span> seed <span class="token operator">&gt;&gt;</span> <span class="token number">17</span><span class="token punctuation">;</span>  
    seed <span class="token operator">^</span><span class="token operator">=</span> seed <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> seed<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">inline</span> <span class="token keyword">int</span> XOR<span class="token operator">::</span><span class="token function">randomInt</span><span class="token punctuation">(</span><span class="token keyword">int</span> min<span class="token punctuation">,</span> <span class="token keyword">int</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>max <span class="token operator">&lt;</span> min<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        std<span class="token operator">::</span><span class="token function">swap</span><span class="token punctuation">(</span>min<span class="token punctuation">,</span> max<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    uint32_t range <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>max <span class="token operator">-</span> min <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> min <span class="token operator">+</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> range<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">inline</span> <span class="token keyword">float</span> XOR<span class="token operator">::</span><span class="token function">randomFloat</span><span class="token punctuation">(</span><span class="token keyword">float</span> min<span class="token punctuation">,</span> <span class="token keyword">float</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">float</span> normalized <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0f</span> <span class="token operator">/</span> <span class="token number">4294967296.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> min <span class="token operator">+</span> normalized <span class="token operator">*</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min <span class="token operator">+</span> std<span class="token operator">::</span>numeric_limits<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">epsilon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">inline</span> <span class="token keyword">bool</span> XOR<span class="token operator">::</span><span class="token function">chance</span><span class="token punctuation">(</span><span class="token keyword">float</span> probability<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token function">randomFloat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> probability<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">&gt;</span>  
<span class="token keyword">inline</span> T XOR<span class="token operator">::</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;</span> vec<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vec<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">throw</span> std<span class="token operator">::</span><span class="token function">invalid_argument</span><span class="token punctuation">(</span><span class="token string">"Vector is empty"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token function">randomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> vec<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> vec<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token punctuation">,</span> size_t N<span class="token operator">&gt;</span>  
<span class="token keyword">inline</span> T XOR<span class="token operator">::</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token function">T</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>arr<span class="token punctuation">)</span><span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">return</span> arr<span class="token punctuation">[</span><span class="token function">randomInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> N <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>This looks complex but it’s a simple declaration for an <a href="https://en.wikipedia.org/wiki/Xorshift">XORShift</a> PRNG, it’s small and has a very good period (the number of unique values it can generate before repeating) for a 32-bit PRNG. It is a perfectly simple interface for our purposes.</p>
<p><strong>Why not use an inbuilt C++ prng?</strong></p>
<p>We only really need a simple interface for generating random numbers, and the inbuilt PRNGs in C++ are often more complex than we need. We also want to be able to control the seed of our PRNG, which is not always possible with the inbuilt PRNGs. Mainly, though, I just like this implementation.</p>
<p>So aside from seeding the constructor (which we will cover later), the PRNG exposes 4 public methods:</p>
<p><code>randomInt(min, max)</code> which returns a random integer between <code>min</code> and <code>max</code> (inclusive).</p>
<p><code>randomFloat(min, max)</code> which returns a random float between <code>min</code> and <code>max</code> (inclusive).</p>
<p><code>chance(probability)</code> which returns a boolean based on the probability (<code>min: 0.0, max: 1.0</code>) passed in.</p>
<p><code>choose(vec)</code> and <code>choose(arr)</code> which return a random element from a vector or array respectively (these are Template (Generic) functions, they are called exactly the same).</p>
<p>You don’t need to worry about the implementation of these functions, just know that a single XOR instance will be declared with our globals and will be used throughout the application.</p>
<p>We will also implement a couple of utility functions in a new file called <code>util.h</code> which will be used throughout the game.</p>
<p><strong>note:</strong> Both of these header files contain inline definitions as well as the declarations, this is because the functions don’t really help extend or interface with other code (and so it doesn’t make sense to define them alongside other related patterns), they are just small utilities which we want to inline for performance and simplicity.<br>
In the rest of the tutorial we will be decoupling our definitions from our implementation, this is just a small exception.</p>
<p><strong>util.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">pragma</span> once  </span>
  
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"splashkit.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdexcept&gt;</span>  </span>
  
<span class="token comment">/**  
 * @brief Convert a hex string to a color.  
 *  
 * @param hex The hex string.  
 * @return color The color.  
 */</span>  
<span class="token keyword">inline</span> color <span class="token function">color_from_hex</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> hex<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">int</span> r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">;</span>  
    <span class="token function">sscanf</span><span class="token punctuation">(</span>hex<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"#%02x%02x%02x"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>r<span class="token punctuation">,</span> <span class="token operator">&amp;</span>g<span class="token punctuation">,</span> <span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> <span class="token function">rgb_color</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> g<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token comment">/**  
 * @brief Map a value from one range to another.  
 *  
 * @param value The value to map.  
 * @param input_min The input minimum.  
 * @param input_max The input maximum.  
 * @param output_min The output minimum.  
 * @param output_max The output maximum.  
 * @return double The mapped value.  
 */</span>  
<span class="token keyword">inline</span> <span class="token keyword">double</span> <span class="token function">map_value</span><span class="token punctuation">(</span><span class="token keyword">double</span> value<span class="token punctuation">,</span> <span class="token keyword">double</span> input_min<span class="token punctuation">,</span> <span class="token keyword">double</span> input_max<span class="token punctuation">,</span> <span class="token keyword">double</span> output_min<span class="token punctuation">,</span> <span class="token keyword">double</span> output_max<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token comment">// Calculate the ratio between the input range and output range  </span>
    <span class="token keyword">double</span> scale <span class="token operator">=</span> <span class="token punctuation">(</span>output_max <span class="token operator">-</span> output_min<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>input_max <span class="token operator">-</span> input_min<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// Map the value to the new range  </span>
    <span class="token keyword">return</span> output_min <span class="token operator">+</span> <span class="token punctuation">(</span>value <span class="token operator">-</span> input_min<span class="token punctuation">)</span> <span class="token operator">*</span> scale<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token comment">/**  
 * @brief Clamp a value between a low and high value.  
 *  
 * @tparam T The value type.  
 * @param value The value to clamp.  
 * @param low The low value.  
 * @param high The high value.  
 * @return T The clamped value.  
 */</span>  
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">&gt;</span>  
T <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token keyword">const</span> T<span class="token operator">&amp;</span> value<span class="token punctuation">,</span> <span class="token keyword">const</span> T<span class="token operator">&amp;</span> low<span class="token punctuation">,</span> <span class="token keyword">const</span> T<span class="token operator">&amp;</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">&gt;</span>  
T <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token keyword">const</span> T<span class="token operator">&amp;</span> value<span class="token punctuation">,</span> <span class="token keyword">const</span> T<span class="token operator">&amp;</span> low<span class="token punctuation">,</span> <span class="token keyword">const</span> T<span class="token operator">&amp;</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> low<span class="token punctuation">)</span> <span class="token operator">?</span> low <span class="token operator">:</span> <span class="token punctuation">(</span>value <span class="token operator">&gt;</span> high<span class="token punctuation">)</span> <span class="token operator">?</span> high <span class="token operator">:</span> value<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>Briefly, these 3 functions are:</p>
<p><code>color_from_hex(hex)</code> which takes a hex string and returns a Splashkit color object (very useful when working with colour tools like <a href="https://p4lette.app">p4lette</a>).</p>
<p><code>map_value(value, input_min, input_max, output_min, output_max)</code> which maps a value from one range to another (useful for scaling values).</p>
<p><code>clamp(value, low, high)</code> which clamps a value between a low and high value (useful for ensuring values are within a certain range).</p>
<p>These functions are simple and will be used throughout the game to simplify and abstract some common operations.</p>
<p>Next we will look at how to set up the constant values which will help define our game space.</p>
<h1 id="setting-up-global-constants">Setting Up Global Constants</h1>
<p>Global constants are where we define the overall settings and configurations of the game. We’ll use <code>globals.h</code> to declare <em>and</em> define these constants as we are using some operators (<code>inline constexpr</code>) which require a value to be known at compile time / defined in a header.</p>
<p>You do not necessarily have to use this pattern, it’s fine to use <code>extern const</code> and define the values in a source file, or simply define these values as <code>const</code> in a header file. The important thing is that you maintain a single source of truth for these values.<br>
This is a good practice as it allows us to easily modify the game’s settings from a central location.</p>
<h3 id="globals.h">globals.h</h3>
<p>In <code>globals.h</code>, we declare global <strong>constants</strong> (immutable values) that will be used throughout the game. This header file acts as a central point of reference for all global settings. We maintain these separately from our gamestate struct as they are <strong>not mutable</strong> values, they function as universal rules which our gameplay systems are implemented against and as such they should be abstracted as far away from our mechanical functionality as possible.</p>
<p><strong>globals.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">pragma</span> once  </span>
  
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"splashkit.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"XOR.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"util.h"</span>  </span>
  
<span class="token comment">/**  
 * @brief The global window dimensions.  
 *  
 */</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> WINDOW_WIDTH <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> WINDOW_HEIGHT <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>  
  
<span class="token comment">/**  
 * @brief The global game area dimensions.  
 *  
 */</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> GAME_AREA_WIDTH <span class="token operator">=</span> <span class="token number">600</span><span class="token punctuation">;</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> GAME_AREA_HEIGHT <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> GAME_AREA_OFFSET <span class="token operator">=</span> <span class="token punctuation">(</span>WINDOW_WIDTH <span class="token operator">-</span> GAME_AREA_WIDTH<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> GAME_AREA_START <span class="token operator">=</span> GAME_AREA_OFFSET<span class="token punctuation">;</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> GAME_AREA_END <span class="token operator">=</span> GAME_AREA_START <span class="token operator">+</span> GAME_AREA_WIDTH<span class="token punctuation">;</span>  
  
<span class="token comment">/**  
 * @brief The global terrain dimensions and offsets relative to window.  
 *  
 */</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> TERRAIN_OFFSET <span class="token operator">=</span> GAME_AREA_OFFSET <span class="token operator">+</span> GAME_AREA_WIDTH <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">;</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> TERRAIN_WIDTH <span class="token operator">=</span> GAME_AREA_WIDTH <span class="token operator">-</span> GAME_AREA_WIDTH <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">;</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> TERRAIN_HEIGHT <span class="token operator">=</span> TERRAIN_WIDTH<span class="token punctuation">;</span>  
  
<span class="token comment">/**  
 * @brief Terrain dimensions  
 *  
 */</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> NUM_ROWS <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> NUM_COLS <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>  
  
<span class="token comment">/**  
 * @brief The global block dimensions inside the Terrain Grid.  
 *  
 */</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> BLOCK_WIDTH <span class="token operator">=</span> TERRAIN_WIDTH <span class="token operator">/</span> NUM_COLS<span class="token punctuation">;</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> BLOCK_HEIGHT <span class="token operator">=</span> TERRAIN_HEIGHT <span class="token operator">/</span> NUM_ROWS<span class="token punctuation">;</span>  
  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">float</span> BLOCK_POWERUP_CHANCE <span class="token operator">=</span> <span class="token number">0.02</span><span class="token punctuation">;</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> INITIAL_PADDLE_WIDTH <span class="token operator">=</span> WINDOW_WIDTH <span class="token operator">/</span> <span class="token number">10</span><span class="token punctuation">;</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> MAX_PADDLE_WIDTH <span class="token operator">=</span> INITIAL_PADDLE_WIDTH <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>  
<span class="token keyword">inline</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> MIN_PADDLE_WIDTH <span class="token operator">=</span> INITIAL_PADDLE_WIDTH <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>  
  
  
<span class="token comment">// rng  </span>
<span class="token comment">/**  
 * @brief The global random number generator.  
 *  
 */</span>  
<span class="token keyword">inline</span> XOR rng <span class="token operator">=</span> <span class="token function">XOR</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token comment">/**  
 * @brief The game palette.  
 *  
 */</span>  
<span class="token keyword">const</span> color clr_background <span class="token operator">=</span> <span class="token function">color_from_hex</span><span class="token punctuation">(</span><span class="token string">"#000000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">const</span> color clr_paddle <span class="token operator">=</span> <span class="token function">color_from_hex</span><span class="token punctuation">(</span><span class="token string">"#FBF6E0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">const</span> color clr_block <span class="token operator">=</span> <span class="token function">color_from_hex</span><span class="token punctuation">(</span><span class="token string">"#FBF6E0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">const</span> color clr_ball_standard <span class="token operator">=</span> <span class="token function">color_from_hex</span><span class="token punctuation">(</span><span class="token string">"#FBF6E0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">const</span> color clr_ball_explosion <span class="token operator">=</span> <span class="token function">color_from_hex</span><span class="token punctuation">(</span><span class="token string">"#FF2727"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">const</span> color clr_ball_acid <span class="token operator">=</span> <span class="token function">color_from_hex</span><span class="token punctuation">(</span><span class="token string">"#AFFF26"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre>
<p>Most of these are spatial parameters which will be used to define the game space and the entities within it. We also define some colors which will be used to render the game entities. The global <code>XOR</code> PRNG instance is also declared here, as are the color objects which inform the game palette.</p>
<p>There is a lot going on here which you don’t need to worry too much about, these variables are defined relative to each other so that changes to the overall dimensions of the game space are reflected in the dimensions of the entities within it.</p>
<p>Just to show you how these values are being used, and why there are so many of them, let’s fast forward and have a look at this breakdown of the game screen:</p>
<p><img src="tutorial_assets/consts.png" alt="constants demo"></p>
<p>Take your time to get a feel for how these values are being used relative to each other, and have a think about what else they might be used for later in our development.</p>
<p><strong>note:</strong> For the rest of the tutorial we will be omitting the Doxygen comments for brevity, however they will be available in the provided source code.</p>
<p>Now we can edit our main file to use some these variables during window instantiation.</p>
<p><strong>program.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token comment">// import  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"splashkit.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"globals.h"</span> </span><span class="token comment">// &lt;- added this import  </span>
  
<span class="token comment">// we will declare these in header files later  </span>
<span class="token keyword">void</span> <span class="token function">update_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">void</span> <span class="token function">draw_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token punctuation">{</span>  
    <span class="token comment">// Open the window to begin the game  </span>
    <span class="token comment">// using new global constants  </span>
    <span class="token function">open_window</span><span class="token punctuation">(</span><span class="token string">"BreakIn"</span><span class="token punctuation">,</span> WINDOW_WIDTH<span class="token punctuation">,</span> WINDOW_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">hide_mouse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hide mouse while cursor is over game window  </span>
  
    <span class="token comment">// Main game loop: continues to run until the window is closed  </span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">quit_requested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
        <span class="token comment">// Ingest input from peripheral devices  </span>
        <span class="token function">process_events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// Update game state values (we will implement this routine ourselves)  </span>
        <span class="token function">update_global_state</span><span class="token punctuation">(</span>gamestate<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// Draw to frame buffer (we will also implement this)  </span>
        <span class="token function">draw_global_state</span><span class="token punctuation">(</span>gamestate<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// Refresh at target frames per second  </span>
        <span class="token function">refresh_screen</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token comment">// Close the game window and clean up resources  </span>
    <span class="token function">close_window</span><span class="token punctuation">(</span><span class="token string">"BreakIn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>In later sections, we’ll access these global constants to during the initialisation of some of our game entities.</p>
<h1 id="global-state-management">Global State Management</h1>
<p>In BreakIn, we use a struct to encapsulate our mutable game data, which most functions we will implement later accept a reference to as an argument. This allows for extremely granular and high-level control over what state is updated and when, and forces us to be more accountable when we implement patterns which mutate state. By explicitly requiring the game state to be passed as an argument, it keeps the function’s dependencies clear and makes it easy to see how the game state is being modified.</p>
<h3 id="implementing-gamestate">Implementing GameState</h3>
<p>With our <code>GameState</code> struct, we can start defining the variables that will hold the game’s mutable data. For now, we’ll keep it simple with just a couple of variables, but this will expand as we add more features to the game.</p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">struct</span> GameState <span class="token punctuation">{</span>  
    <span class="token keyword">int</span> score<span class="token punctuation">;</span>  
    <span class="token comment">// Additional game state variables will be added here  </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
<h3 id="gamestatus-enum">GameStatus Enum</h3>
<p>In addition to the <code>GameState</code> struct, we have the <code>GameStatus</code> enum to represent the high-level states of the game, such as whether the game is in the menu, in play, paused, or has ended.</p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">enum</span> GameStatus <span class="token punctuation">{</span>  
    MENU<span class="token punctuation">,</span>  
    PLAYING<span class="token punctuation">,</span>  
    PAUSED<span class="token punctuation">,</span>  
    ENDED  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
<p>This enum type will be used to control the flow of the game and determine which high-level control pattern should be executed at any given time.</p>
<p>Now we can extend our <code>GameState</code> definition to include a GameStatus struct as a member variable, as it constitutes part of our mutable state.</p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">struct</span> GameState <span class="token punctuation">{</span>  
    <span class="token keyword">int</span> score<span class="token punctuation">;</span>  
    GameStatus game_status<span class="token punctuation">;</span>  
    <span class="token comment">// Additional game state variables will be added here  </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
<p>Finally, we will define these structs inside a new header filed called <code>types.h</code> located in our root directory.</p>
<p><strong>types.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">pragma</span> once </span><span class="token comment">// linker flag  </span>
  
<span class="token keyword">enum</span> GameStatus <span class="token punctuation">{</span>  
    MENU<span class="token punctuation">,</span>  
    PLAYING<span class="token punctuation">,</span>  
    PAUSED<span class="token punctuation">,</span>  
    ENDED  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
  
  
<span class="token keyword">struct</span> GameState <span class="token punctuation">{</span>  
    <span class="token keyword">int</span> score<span class="token punctuation">;</span>  
    GameStatus game_status<span class="token punctuation">;</span>  
    <span class="token comment">// Additional game state variables will be added here  </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
<p>We will cover instantiating and updating this state in later sections, for now let’s think about what minimum functionality our game needs and go about implementing it.</p>
<h2 id="basic-game-entities">Basic Game Entities</h2>
<p>With the global state management set up, we can now define the basic entities in BreakIn: blocks, balls, and the paddle. These entities will have minimal properties to begin with.</p>
<h3 id="block-struct">Block Struct</h3>
<p>The <code>Block</code> struct represents the individual blocks that the player aims to break with the ball. Each block has an active state and a position.</p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">struct</span> Block <span class="token punctuation">{</span>  
    <span class="token keyword">bool</span> active<span class="token punctuation">;</span>  
    point_2d pos<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
<h3 id="paddle-struct">Paddle Struct</h3>
<p>The <code>Paddle</code> struct represents the player’s paddle, which can move horizontally. The paddle has a position.</p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">struct</span> Paddle <span class="token punctuation">{</span>  
    point_2d pos<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
<h3 id="ball-struct">Ball Struct</h3>
<p>The <code>Ball</code> struct represents the projectiles which collide with the paddle and with blocks. Each ball has an active state, a position, and a velocity.</p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">struct</span> Ball <span class="token punctuation">{</span>  
    <span class="token keyword">bool</span> active<span class="token punctuation">;</span>  
    point_2d pos<span class="token punctuation">;</span>  
    vector_2d vel<span class="token punctuation">;</span> <span class="token comment">// velocity along x and y axes  </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
<p><strong>note:</strong> <code>point_2d</code> and <code>vector_2d</code> are datatypes exposed by Splashkit and can be referenced in any file that imports the Splashkit library, they are both structs which look like:</p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">struct</span> <span class="token punctuation">{</span>  
    <span class="token keyword">float</span> x<span class="token punctuation">;</span>  
    <span class="token keyword">float</span> y<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>Now we can update our <code>types.h</code> file to look like:</p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">pragma</span> once </span><span class="token comment">// linker flag  </span>
  
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"splashkit.h"</span>  </span>
  
<span class="token keyword">struct</span> Ball <span class="token punctuation">{</span>  
    <span class="token keyword">bool</span> active<span class="token punctuation">;</span>  
    point_2d pos<span class="token punctuation">;</span>  
    vector_2d vel<span class="token punctuation">;</span> <span class="token comment">// velocity along x and y axes  </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
  
<span class="token keyword">struct</span> Paddle <span class="token punctuation">{</span>  
    <span class="token keyword">bool</span> active<span class="token punctuation">;</span>  
    point_2d pos<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
  
<span class="token keyword">struct</span> Block <span class="token punctuation">{</span>  
    <span class="token keyword">bool</span> active<span class="token punctuation">;</span>  
    point_2d pos<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
  
<span class="token keyword">enum</span> GameStatus <span class="token punctuation">{</span>  
    MENU<span class="token punctuation">,</span>  
    PLAYING<span class="token punctuation">,</span>  
    PAUSED<span class="token punctuation">,</span>  
    ENDED  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
  
<span class="token keyword">struct</span> GameState <span class="token punctuation">{</span>  
    <span class="token keyword">int</span> score<span class="token punctuation">;</span>  
    GameStatus game_status<span class="token punctuation">;</span>  
    <span class="token comment">// Additional game state variables will be added here  </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
<p>So, we are creating a system of entity types which will exist (based on their <code>pos</code> (position) property) in an abstract space (which we defined above) when instantiated. This abstract space is independent of any visual representation; it is a conceptual framework where our game objects interact and change state based on the game’s rules and logic.</p>
<p>In essence, we are simulating a system of interactions and changes in the background, driven solely by the values and states of our entities. It is only at each time step that this abstract system is translated into a rendered frame, providing the visual representation of our game on the screen. For instance, while our position vectors currently correspond 1:1 with pixel positions within the game window, we could easily make our abstract space much bigger or smaller than the space our internal values correspond to, and draw their graphics against some function of the differential between the two spaces (ie. double the position vector before drawing if the screen space is 2:1 our abstract space).</p>
<p>The game’s logic and mechanics are maintained completely separately from, and only interact with our render in one direction (nothing in our draw functions will mutate the state of the game).</p>
<p>With that in mind, let’s look at how we can place stuff in this space.</p>
<h1 id="initialising-game-entities">Initialising Game Entities</h1>
<p>With our basic game entities and global constants set up, we can now focus on initialising the game state and individual entities like the paddle, balls, and blocks.</p>
<p>We will use top-level functions to instantiate game entities such as the paddle, ball, and blocks, instead of using class constructors. This design choice is aligned with our functional programming approach, which emphasises the use of functions to create and manipulate data.</p>
<p>One of the reasons for this approach is to maintain a clear separation between the game entities (represented by structs) and the logic used to create and manipulate them. By using top-level functions, we can keep our data structures simple and focused solely on holding data, while the functions handle the creation and initialisation logic.</p>
<p>In a new file (<code>state_init.h</code>) we will declare some initialisation functions.</p>
<p><strong>state_init.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">pragma</span> once </span><span class="token comment">// linker flag  </span>
  
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"types.h"</span>  </span>
  
Paddle <span class="token function">new_paddle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
Ball <span class="token function">new_ball</span><span class="token punctuation">(</span>point_2d pos<span class="token punctuation">,</span> vector_2d vel<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> color clr<span class="token punctuation">)</span><span class="token punctuation">;</span>  
Block <span class="token function">new_block</span><span class="token punctuation">(</span>point_2d pos<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> color clr<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre>
<p>By making the paddle position (and below, dimensions) a function of our screen space (remember the paddle constants in <code>globals.h</code>), it means we can adjust the screen dimensions without worrying about the relative position and size of our paddle.</p>
<p>Then in <code>state_init.cpp</code> we can define the function bodies.</p>
<p><strong>state_init.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"globals.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_init.h"</span>  </span>
  
<span class="token comment">// new_paddle takes no arguments as all its properties  </span>
<span class="token comment">// are derived from global constant values  </span>
Paddle <span class="token function">new_paddle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    Paddle paddle<span class="token punctuation">;</span>  
    <span class="token comment">// make paddle's initial position center-bottom  </span>
    paddle<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">=</span> WINDOW_WIDTH <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>  
    paddle<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">=</span> WINDOW_HEIGHT <span class="token operator">-</span> <span class="token number">50</span><span class="token punctuation">;</span>  
    paddle<span class="token punctuation">.</span>width <span class="token operator">=</span> INITIAL_PADDLE_WIDTH<span class="token punctuation">;</span>  
    paddle<span class="token punctuation">.</span>height <span class="token operator">=</span> WINDOW_HEIGHT <span class="token operator">/</span> <span class="token number">80</span><span class="token punctuation">;</span>  
    paddle<span class="token punctuation">.</span>clr <span class="token operator">=</span> clr_paddle<span class="token punctuation">;</span> <span class="token comment">// global constant  </span>
    <span class="token keyword">return</span> paddle<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
Ball <span class="token function">new_ball</span><span class="token punctuation">(</span>point_2d pos<span class="token punctuation">,</span> vector_2d vel<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> color clr<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    Ball ball<span class="token punctuation">;</span>  
    ball<span class="token punctuation">.</span>pos <span class="token operator">=</span> pos<span class="token punctuation">;</span>  
    ball<span class="token punctuation">.</span>vel <span class="token operator">=</span> vel<span class="token punctuation">;</span>  
    ball<span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>  
    ball<span class="token punctuation">.</span>clr <span class="token operator">=</span> clr<span class="token punctuation">;</span>  
    ball<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> ball<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
Block <span class="token function">new_block</span><span class="token punctuation">(</span>point_2d pos<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> color clr<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    Block block<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>pos <span class="token operator">=</span> pos<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>clr <span class="token operator">=</span> clr<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> block<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>You will notice we are instantiating properties which we did not define in <code>types.h</code> against these structs, now would be a good time to add them. Both <code>Paddle</code> and <code>Block</code> will need <code>int</code> width and height properties while our <code>Ball</code>s will always be symmetrical and thus only require a <code>size</code> property. We’re also adding a <code>color</code> property to each, <code>color</code> is a Splashkit type. These will be used to inform the draw and collision functions we will develop later:</p>
<p><strong>types.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">pragma</span> once  </span>
  
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"splashkit.h"</span>  </span>
  
<span class="token keyword">struct</span> Ball <span class="token punctuation">{</span>  
    <span class="token keyword">bool</span> active<span class="token punctuation">;</span>  
    point_2d pos<span class="token punctuation">;</span>  
    vector_2d vel<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>  
    color clr<span class="token punctuation">;</span> <span class="token comment">// `color` is a Splashkit type  </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
  
<span class="token keyword">struct</span> Paddle <span class="token punctuation">{</span>  
    point_2d pos<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> width<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> height<span class="token punctuation">;</span>  
    color clr<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
  
<span class="token keyword">struct</span> Block <span class="token punctuation">{</span>  
    <span class="token keyword">bool</span> active<span class="token punctuation">;</span>  
    point_2d pos<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> width<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> height<span class="token punctuation">;</span>  
    color clr<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
  
<span class="token keyword">enum</span> GameStatus <span class="token punctuation">{</span>  
    MENU<span class="token punctuation">,</span>  
    PLAYING<span class="token punctuation">,</span>  
    PAUSED<span class="token punctuation">,</span>  
    ENDED  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
  
<span class="token keyword">struct</span> GameState <span class="token punctuation">{</span>  
    <span class="token keyword">int</span> score<span class="token punctuation">;</span>  
    GameStatus game_status<span class="token punctuation">;</span>  
    <span class="token comment">// Additional game state variables will be added here  </span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
<h1 id="terrain-grid-and-block-positioning">Terrain Grid and Block positioning</h1>
<p>Before we dive into updating the game state and handling collisions, let’s take a moment to discuss the Grid system used to represent the blocks in the game, as well as the <code>ivec2</code> type and the purpose of each block storing its own grid position.</p>
<h3 id="terrain-grid">Terrain Grid</h3>
<p>In BreakIn, the blocks are organized in a 2D grid called terrain within the GameState struct. This grid is represented using a special data structure composed of a vector of vectors of unique pointers to Block instances.</p>
<p><strong>types.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token comment">/**  
 * @brief A Row is a vector of unique pointers to blocks.  
 * @details A Row is used to represent a row of blocks in the game.  
 */</span>  
<span class="token keyword">using</span> Row <span class="token operator">=</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Block<span class="token operator">&gt;&gt;</span><span class="token punctuation">;</span>  
  
<span class="token comment">/**  
 * @brief A Grid is a vector of rows.  
 * @details A Grid is used to represent the grid of blocks in the game.  
 */</span>  
<span class="token keyword">using</span> Grid <span class="token operator">=</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Row<span class="token operator">&gt;</span><span class="token punctuation">;</span>  
  
<span class="token comment">// ...other types  </span>
</code></pre>
<p>The <code>Row</code> type is defined as a vector of unique pointers to <code>Block</code> instances. Each element in the <code>Row</code> vector represents a block in that row. The use of unique pointers ensures that each block is owned by the <code>Row</code> and will be automatically deleted when the <code>Row</code> is destroyed or the block is removed from the grid.<br>
The <code>Grid</code> type is defined as a vector of <code>Row</code> instances. Each element in the <code>Grid</code> vector represents a row of blocks in the game. By combining these two types, we create a 2D grid structure that efficiently manages the blocks in the game.<br>
Using this grid system provides several benefits:</p>
<ul>
<li>It allows for easy access and manipulation of blocks based on their row and column positions.</li>
<li>The use of unique pointers ensures proper memory management and ownership of the blocks.</li>
<li>It provides a clear and organized structure for representing the game’s block layout.</li>
</ul>
<h3 id="ivec2-type-and-block-grid-position">ivec2 Type and Block Grid Position</h3>
<p>In addition to the grid system, each <code>Block</code> instance also stores its own grid position using the <code>ivec2</code> type. The <code>ivec2</code> type is a simple struct that represents a 2D vector with integer components.</p>
<p><strong>types.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token comment">/**  
 * @brief A 2D integer vector.  
 * @details An ivec2 is used to represent a 2D vector with integer components.  
 */</span>  
<span class="token keyword">struct</span> ivec2 <span class="token punctuation">{</span>  
    <span class="token keyword">int</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
  
<span class="token comment">// ...other types  </span>
</code></pre>
<p>By storing the grid position internally within each Block instance, we can easily identify the row and column of the block within the grid. This information is useful for various purposes, but fundamentally it gives us a way to find the block in the <code>Grid</code> when we encounter it based on its position in the game space.</p>
<p>Updated version of the <code>Block</code> struct that includes the grid_pos member:</p>
<p><strong>types.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">struct</span> Block <span class="token punctuation">{</span>  
    <span class="token keyword">bool</span> active<span class="token punctuation">;</span>  
    point_2d pos<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> width<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> height<span class="token punctuation">;</span>  
    color clr<span class="token punctuation">;</span>  
    ivec2 grid_pos<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
<p><strong>state_init.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token comment">// ...other declarations  </span>
Block <span class="token function">new_block</span><span class="token punctuation">(</span>point_2d pos<span class="token punctuation">,</span> ivec2 grid_pos<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> color clr<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre>
<p><strong>state_init.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token comment">// ...rest of file  </span>
Block <span class="token function">new_block</span><span class="token punctuation">(</span>point_2d pos<span class="token punctuation">,</span> ivec2 grid_pos<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> color clr<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    Block block<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>pos <span class="token operator">=</span> pos<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>grid_pos <span class="token operator">=</span> grid_pos<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>clr <span class="token operator">=</span> clr<span class="token punctuation">;</span>  
    <span class="token keyword">return</span> block<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>The <code>grid_pos</code> member stores the row and column position of the block within the grid.<br>
With this understanding of the grid system and block positioning, let’s proceed to update the GameState struct and implement the state update functions.</p>
<h1 id="populating-the-grid">Populating the Grid</h1>
<p>For now, we’ll just write a function to return a fully populated <code>Grid</code>. Later we’ll extend this to be more dynamic but right now we just want to get something on the screen.</p>
<h3 id="new_grid">new_grid()</h3>
<p><strong>state_init.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token comment">// ...other declarations  </span>
Grid <span class="token function">new_grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre>
<p><strong>state_init.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token comment">// ...rest of file  </span>
Grid <span class="token function">new_grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    Grid grid<span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> NUM_ROWS<span class="token punctuation">;</span> <span class="token operator">++</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token comment">// create a new row (which is a vector of Blocks remember)  </span>
        Row row<span class="token punctuation">;</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> NUM_COLS<span class="token punctuation">;</span> <span class="token operator">++</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token comment">// assign world position based on global constants  </span>
            point_2d pos <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>TERRAIN_OFFSET <span class="token operator">+</span> x <span class="token operator">*</span> BLOCK_WIDTH<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>y <span class="token operator">*</span> BLOCK_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  
            <span class="token comment">// discrete position in grid structure  </span>
            ivec2 grid_pos <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">,</span> y<span class="token punctuation">}</span><span class="token punctuation">;</span>  
            row<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>Block<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">new_block</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> grid_pos<span class="token punctuation">,</span> BLOCK_WIDTH<span class="token punctuation">,</span> BLOCK_HEIGHT<span class="token punctuation">,</span> clr_block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
        grid<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">return</span> grid<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>Now that we have our entities defined and initialisation functions set up, we can move on to updating the game state and looping back to the event loop.<br>
We will implement very basic state updates in the next section so that we can get something happening on screen, and then move on to more complex interactions and game logic.</p>
<h1 id="updating-state-and-looping-back">Updating State and Looping Back</h1>
<h3 id="updating-the-gamestate-struct">Updating the GameState Struct</h3>
<p>Let’s update the GameState struct in the types.h file to include vectors for the balls and terrain, as well as our player <code>Paddle</code>. We’ll also forward declare our main types so that we can refer to them in this file before they’re defined.</p>
<p><strong>types.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"splashkit.h"</span>  </span>
  
<span class="token keyword">struct</span> ivec2<span class="token punctuation">;</span>  
<span class="token keyword">struct</span> GameState<span class="token punctuation">;</span>  
<span class="token keyword">struct</span> Paddle<span class="token punctuation">;</span>  
<span class="token keyword">struct</span> Ball<span class="token punctuation">;</span>  
<span class="token keyword">struct</span> Block<span class="token punctuation">;</span>  
  
<span class="token comment">// ...other types  </span>
  
<span class="token keyword">struct</span> GameState <span class="token punctuation">{</span>  
    <span class="token keyword">int</span> score<span class="token punctuation">;</span>  
    GameStatus game_status<span class="token punctuation">;</span>  
    Paddle paddle<span class="token punctuation">;</span>  
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Ball<span class="token operator">&gt;</span> balls<span class="token punctuation">;</span>  
    Grid terrain<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
<p>With our game entities defined and initialisation functions set up, we can now focus on updating the game state and looping back to the event loop.</p>
<h3 id="updating-the-gamestate">Updating the GameState</h3>
<p>We need a function to initialise a new GameState instance with default values. Let’s add this function in the state_init.h file.</p>
<p><strong>state_init.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token comment">// ...other declarations  </span>
GameState <span class="token function">new_game_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre>
<p><strong>state_init.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token comment">// ...rest of file  </span>
GameState <span class="token function">new_game_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    GameState game<span class="token punctuation">;</span>  
    game<span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    game<span class="token punctuation">.</span>game_status <span class="token operator">=</span> PLAYING<span class="token punctuation">;</span>  
    game<span class="token punctuation">.</span>terrain <span class="token operator">=</span> <span class="token function">new_grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    game<span class="token punctuation">.</span>paddle <span class="token operator">=</span> <span class="token function">new_paddle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    game<span class="token punctuation">.</span>balls <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> game<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>This function creates a new <code>GameState</code> instance, initialises the score to 0, sets the game status to PLAYING, creates a new grid of blocks, initialises the paddle, and leaves the balls vector empty (we’ll add balls later).</p>
<h3 id="declaring-update-functions">Declaring update functions</h3>
<p>Let’s make a new header file:<br>
<strong>state_management.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">pragma</span> once  </span>
  
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"types.h"</span>  </span>
  
<span class="token comment">// GLOBAL  </span>
<span class="token keyword">void</span> <span class="token function">update_global_state</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
  
<span class="token comment">// BLOCK  </span>
<span class="token keyword">void</span> <span class="token function">block_update</span><span class="token punctuation">(</span>Block<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token comment">// TERRAIN BLOCKS  </span>
<span class="token keyword">void</span> <span class="token function">update_terrain</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
  
<span class="token comment">//BALL  </span>
<span class="token keyword">void</span> <span class="token function">ball_update</span><span class="token punctuation">(</span>Ball<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token keyword">void</span> <span class="token function">ball_check_wall_collision</span><span class="token punctuation">(</span>Ball<span class="token operator">&amp;</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token keyword">void</span> <span class="token function">ball_check_block_collision</span><span class="token punctuation">(</span>Ball<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token keyword">void</span> <span class="token function">ball_check_paddle_collision</span><span class="token punctuation">(</span>Ball<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token keyword">void</span> <span class="token function">update_balls</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
  
<span class="token comment">// PADDLE  </span>
<span class="token keyword">void</span> <span class="token function">paddle_update</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre>
<p>In this file, we declare functions to update the paddle, balls, blocks (terrain), and the global game state. We also have ball functions to check for collisions with the walls, blocks, and paddle which we need to call in the ball update function.</p>
<h3 id="implementing-update-functions">Implementing update functions</h3>
<p>Let’s quickly scaffold these functions then circle back and populate them one at a time:</p>
<p><strong>paddle_state.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_management.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"globals.h"</span>  </span>
  
<span class="token keyword">void</span> <span class="token function">paddle_update</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token comment">// Update paddle position based on user input  </span>
    <span class="token comment">// (to be implemented)  </span>
<span class="token punctuation">}</span>  
</code></pre>
<p><strong>ball_state.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_management.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"globals.h"</span>  </span>
  
<span class="token keyword">void</span> <span class="token function">ball_update</span><span class="token punctuation">(</span>Ball<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>b<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">return</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token comment">// Update ball position  </span>
    b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">+</span><span class="token operator">=</span> b<span class="token punctuation">.</span>vel<span class="token punctuation">.</span>x<span class="token punctuation">;</span>  
    b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">+</span><span class="token operator">=</span> b<span class="token punctuation">.</span>vel<span class="token punctuation">.</span>y<span class="token punctuation">;</span>  
  
    <span class="token comment">// Check for collisions  </span>
    <span class="token function">ball_check_wall_collision</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">ball_check_block_collision</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">ball_check_paddle_collision</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">ball_check_wall_collision</span><span class="token punctuation">(</span>Ball<span class="token operator">&amp;</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token comment">// Check for collision with walls and update velocity accordingly  </span>
    <span class="token comment">// (to be implemented)  </span>
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">ball_check_block_collision</span><span class="token punctuation">(</span>Ball<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token comment">// Check for collision with blocks and update block state and ball velocity  </span>
    <span class="token comment">// (to be implemented)  </span>
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">ball_check_paddle_collision</span><span class="token punctuation">(</span>Ball<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token comment">// Check for collision with paddle and update ball velocity  </span>
    <span class="token comment">// (to be implemented)  </span>
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">update_balls</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> ball <span class="token operator">:</span> g<span class="token punctuation">.</span>balls<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">ball_update</span><span class="token punctuation">(</span>ball<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token comment">// Remove inactive balls from the vector  </span>
    g<span class="token punctuation">.</span>balls<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">remove_if</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>balls<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>balls<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> Ball<span class="token operator">&amp;</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span>b<span class="token punctuation">.</span>active<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>balls<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>The pattern here where we pass the game state by reference to each function is important, it allows us to update the game state in a controlled and predictable way. We will be able to see exactly what is being updated and when, and we can easily add new functionality by adding new functions which take the game state as an argument.</p>
<p>The other pattern to note is <code>update_balls</code> which iterates over the balls in the game state and calls <code>ball_update</code> on each one. This is a common pattern in game development, where you have a collection of entities which need to be updated in the same way each frame.</p>
<p><strong>block_state.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_management.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"globals.h"</span>  </span>
  
<span class="token keyword">void</span> <span class="token function">block_update</span><span class="token punctuation">(</span>Block<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>b<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">return</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token comment">// Update block state  </span>
    <span class="token comment">// (to be implemented)  </span>
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">update_terrain</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token comment">// Update each block  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> row <span class="token operator">:</span> g<span class="token punctuation">.</span>terrain<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> block <span class="token operator">:</span> row<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token function">block_update</span><span class="token punctuation">(</span><span class="token operator">*</span>block<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>block<span class="token operator">-</span><span class="token operator">&gt;</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                    block<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Automatically deletes the block and sets the pointer to nullptr  </span>
                <span class="token punctuation">}</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>At this point it is natural to be wondering what the purpose of the <code>active</code> property is when we could just destroy the object when it is no longer needed. This is an order of operations consideration; imagine we have a collision which destroys a block and spawns a powerup, we want to be able to update the block state and then spawn the powerup in the same frame. By setting the block to inactive we can ensure that the block is not drawn or updated, but we can still access its properties and use them to spawn a powerup (or particles or whatever) before we delete the block (so we can still access its position etc even after it stops being part of the game).</p>
<p>So where we have the check: <code>if (!b.active) return;</code> instead of returning we could call a function to spawn a powerup or particles or whatever, as <code>block_update()</code> is called before the block is deleted in <code>update_blocks()</code>.</p>
<p><strong>global_state.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_management.h"</span>  </span>
  
<span class="token keyword">void</span> <span class="token function">update_global_state</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token function">paddle_update</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">update_balls</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">update_terrain</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>This function will be called in the main game loop to update the game state each frame. It calls the other update functions to update the paddle, balls, and blocks.</p>
<p>Now let’s fill in the missing code in the update functions and explain what’s happening in each one.</p>
<p><strong>paddle_state.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_management.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"globals.h"</span>  </span>
  
<span class="token keyword">void</span> <span class="token function">paddle_update</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    g<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token function">mouse_x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GAME_AREA_START<span class="token punctuation">,</span> GAME_AREA_END <span class="token operator">-</span> g<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>width<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>In the <code>paddle_update</code> function, we update the paddle’s position based on the mouse’s x-coordinate. We use the <code>clamp</code> function from util.h to ensure that the paddle stays within the game area’s boundaries, taking into account the paddle’s width.</p>
<p>When we talk about taking in to account the paddle’s width, it’s important to mention that in Splashkit (and many other graphical frameworks) the origin of a rectangle is its top-left corner. This means that when we draw a rectangle at a given position, the position refers to the top-left corner of the rectangle. This is important to remember when calculating the position of the paddle, as we need to ensure that the entire paddle is within the game area.</p>
<p>In this situation, we are setting the x-coordinate of the paddle to the mouse’s x-coordinate, but we also need to ensure that the entire paddle is within the game area. To do this, we use the <code>clamp</code> function to ensure that the paddle’s x-coordinate is within the game area’s boundaries, which means subtracting the paddle’s width from the game area’s end position (if the origin of the paddle is <code>paddle.width</code> away from the right edge of the game area, the right edge of the paddle will be at the right edge of the game area).</p>
<p><img src="tutorial_assets/paddle_boundary.gif" alt="paddle width"></p>
<p><strong>ball_state.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_management.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"globals.h"</span>  </span>
  
<span class="token keyword">void</span> <span class="token function">ball_update</span><span class="token punctuation">(</span>Ball<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>b<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">return</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token comment">// Update ball position  </span>
    b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">+</span><span class="token operator">=</span> b<span class="token punctuation">.</span>vel<span class="token punctuation">.</span>x<span class="token punctuation">;</span>  
    b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">+</span><span class="token operator">=</span> b<span class="token punctuation">.</span>vel<span class="token punctuation">.</span>y<span class="token punctuation">;</span>  
  
    <span class="token comment">// Check for collisions  </span>
    <span class="token function">ball_check_wall_collision</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">ball_check_block_collision</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">ball_check_paddle_collision</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">ball_check_wall_collision</span><span class="token punctuation">(</span>Ball<span class="token operator">&amp;</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> GAME_AREA_HEIGHT<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        b<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
        <span class="token keyword">return</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> GAME_AREA_START <span class="token operator">+</span> b<span class="token punctuation">.</span>size <span class="token operator">||</span> b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">&gt;</span> GAME_AREA_END <span class="token operator">-</span> b<span class="token punctuation">.</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> GAME_AREA_START <span class="token operator">+</span> b<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token operator">?</span> GAME_AREA_START <span class="token operator">+</span> b<span class="token punctuation">.</span>size <span class="token operator">:</span> GAME_AREA_END <span class="token operator">-</span> b<span class="token punctuation">.</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>  
        b<span class="token punctuation">.</span>vel<span class="token punctuation">.</span>x <span class="token operator">*</span><span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">+</span> b<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">+</span> b<span class="token punctuation">.</span>size<span class="token punctuation">;</span>  
        b<span class="token punctuation">.</span>vel<span class="token punctuation">.</span>y <span class="token operator">*</span><span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">ball_check_block_collision</span><span class="token punctuation">(</span>Ball<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> row <span class="token operator">:</span> g<span class="token punctuation">.</span>terrain<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> block <span class="token operator">:</span> row<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span>block <span class="token operator">&amp;&amp;</span> block<span class="token operator">-</span><span class="token operator">&gt;</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token comment">// Check for collision  </span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> block<span class="token operator">-</span><span class="token operator">&gt;</span>pos<span class="token punctuation">.</span>x <span class="token operator">+</span> block<span class="token operator">-</span><span class="token operator">&gt;</span>width <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">+</span> b<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> block<span class="token operator">-</span><span class="token operator">&gt;</span>pos<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span>  
                    b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> block<span class="token operator">-</span><span class="token operator">&gt;</span>pos<span class="token punctuation">.</span>y <span class="token operator">+</span> block<span class="token operator">-</span><span class="token operator">&gt;</span>height <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">+</span> b<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> block<span class="token operator">-</span><span class="token operator">&gt;</span>pos<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                    block<span class="token operator">-</span><span class="token operator">&gt;</span>active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
                    g<span class="token punctuation">.</span>score <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>  
  
                    <span class="token comment">// Determine collision direction (which side of block was hit)  </span>
                    <span class="token keyword">float</span> overlapLeft <span class="token operator">=</span> <span class="token punctuation">(</span>block<span class="token operator">-</span><span class="token operator">&gt;</span>pos<span class="token punctuation">.</span>x <span class="token operator">+</span> block<span class="token operator">-</span><span class="token operator">&gt;</span>width<span class="token punctuation">)</span> <span class="token operator">-</span> b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x<span class="token punctuation">;</span>  
                    <span class="token keyword">float</span> overlapRight <span class="token operator">=</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">+</span> b<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token operator">-</span> block<span class="token operator">-</span><span class="token operator">&gt;</span>pos<span class="token punctuation">.</span>x<span class="token punctuation">;</span>  
                    <span class="token keyword">float</span> overlapTop <span class="token operator">=</span> <span class="token punctuation">(</span>block<span class="token operator">-</span><span class="token operator">&gt;</span>pos<span class="token punctuation">.</span>y <span class="token operator">+</span> block<span class="token operator">-</span><span class="token operator">&gt;</span>height<span class="token punctuation">)</span> <span class="token operator">-</span> b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y<span class="token punctuation">;</span>  
                    <span class="token keyword">float</span> overlapBottom <span class="token operator">=</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">+</span> b<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token operator">-</span> block<span class="token operator">-</span><span class="token operator">&gt;</span>pos<span class="token punctuation">.</span>y<span class="token punctuation">;</span>  
  
                    <span class="token keyword">bool</span> x_overlap <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span>overlapLeft<span class="token punctuation">,</span> overlapRight<span class="token punctuation">)</span> <span class="token operator">&lt;</span> std<span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span>overlapTop<span class="token punctuation">,</span> overlapBottom<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    <span class="token comment">// Reverse velocity based on the smallest overlap  </span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>x_overlap<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                        b<span class="token punctuation">.</span>vel<span class="token punctuation">.</span>x <span class="token operator">*</span><span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Horizontal collision  </span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  
                        b<span class="token punctuation">.</span>vel<span class="token punctuation">.</span>y <span class="token operator">*</span><span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Vertical collision  </span>
                    <span class="token punctuation">}</span>  
                <span class="token punctuation">}</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">ball_check_paddle_collision</span><span class="token punctuation">(</span>Ball<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> g<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">+</span> g<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>width <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">+</span> b<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> g<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">&gt;=</span> g<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        b<span class="token punctuation">.</span>vel<span class="token punctuation">.</span>y <span class="token operator">*</span><span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
        <span class="token comment">// adjust x velocity based on how close to centre of paddle the ball hits (further to edge = faster x rebound)  </span>
        b<span class="token punctuation">.</span>vel<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token function">map_value</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token punctuation">(</span>g<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">+</span> g<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>width <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">update_balls</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> ball <span class="token operator">:</span> g<span class="token punctuation">.</span>balls<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">ball_update</span><span class="token punctuation">(</span>ball<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token comment">// Remove inactive balls from the vector  </span>
    g<span class="token punctuation">.</span>balls<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">remove_if</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>balls<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>balls<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> Ball<span class="token operator">&amp;</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">!</span>b<span class="token punctuation">.</span>active<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>balls<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>In <code>ball_update</code>, we update the ball’s position based on its velocity. We then check for collisions with the walls, blocks, and paddle using separate functions.</p>
<p><code>ball_check_wall_collision</code> checks if the ball has collided with any of the walls and reverses its velocity accordingly. If the ball goes below the game area, it is deactivated.</p>
<p><code>ball_check_block_collision</code> iterates through the terrain grid and checks if the ball has collided with any active blocks using AABB collision detection. If a collision is detected, the block is deactivated, and the ball’s y-velocity is reversed.</p>
<p><code>ball_check_paddle_collision</code> checks if the ball has collided with the paddle and reverses its y-velocity. It also adjusts the ball’s x-velocity based on the collision position using the map_value function from util.h.</p>
<p><code>update_balls</code> iterates through all the balls and calls ball_update for each one. It then removes any inactive balls from the vector using the erase-remove_if idiom.</p>
<p>Our <code>Block</code> / terrain update functions are fine as-is for now.</p>
<h1 id="drawing-the-game">Drawing the game</h1>
<p>Now let’s implement the draw functions so we can see our game in action. We’ll create a new header file called draw.h to declare our draw functions and implement them in a corresponding <code>draw.cpp</code> file.</p>
<p><strong>draw.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"types.h"</span>  </span>
  
<span class="token keyword">void</span> <span class="token function">draw_global_state</span><span class="token punctuation">(</span><span class="token keyword">const</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
  
<span class="token keyword">void</span> <span class="token function">block_draw</span><span class="token punctuation">(</span><span class="token keyword">const</span> Block<span class="token operator">&amp;</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token keyword">void</span> <span class="token function">draw_terrain</span><span class="token punctuation">(</span><span class="token keyword">const</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
  
<span class="token keyword">void</span> <span class="token function">ball_draw</span><span class="token punctuation">(</span><span class="token keyword">const</span> Ball<span class="token operator">&amp;</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token keyword">void</span> <span class="token function">draw_balls</span><span class="token punctuation">(</span><span class="token keyword">const</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token keyword">void</span> <span class="token function">paddle_draw</span><span class="token punctuation">(</span><span class="token keyword">const</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
</code></pre>
<p><strong>draw.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"draw.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"globals.h"</span>  </span>
  
<span class="token keyword">void</span> <span class="token function">draw_global_state</span><span class="token punctuation">(</span><span class="token keyword">const</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token function">clear_screen</span><span class="token punctuation">(</span>clr_background<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">fill_rectangle</span><span class="token punctuation">(</span><span class="token function">color_from_hex</span><span class="token punctuation">(</span><span class="token string">"#FBF6E0"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GAME_AREA_START <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GAME_AREA_WIDTH <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">,</span> GAME_AREA_HEIGHT <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">fill_rectangle</span><span class="token punctuation">(</span>clr_background<span class="token punctuation">,</span> GAME_AREA_START<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GAME_AREA_WIDTH<span class="token punctuation">,</span> GAME_AREA_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">draw_text</span><span class="token punctuation">(</span><span class="token string">"score: "</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">,</span> COLOR_WHITE<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token function">option_to_screen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">draw_terrain</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">paddle_draw</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">draw_balls</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">block_draw</span><span class="token punctuation">(</span><span class="token keyword">const</span> Block<span class="token operator">&amp;</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">fill_rectangle</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>clr<span class="token punctuation">,</span> b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y<span class="token punctuation">,</span> b<span class="token punctuation">.</span>width<span class="token punctuation">,</span> b<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">draw_terrain</span><span class="token punctuation">(</span><span class="token keyword">const</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> row <span class="token operator">:</span> g<span class="token punctuation">.</span>terrain<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> block <span class="token operator">:</span> row<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token function">block_draw</span><span class="token punctuation">(</span><span class="token operator">*</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">ball_draw</span><span class="token punctuation">(</span><span class="token keyword">const</span> Ball<span class="token operator">&amp;</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token function">fill_circle</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>clr<span class="token punctuation">,</span> b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y<span class="token punctuation">,</span> b<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">draw_balls</span><span class="token punctuation">(</span><span class="token keyword">const</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> b <span class="token operator">:</span> g<span class="token punctuation">.</span>balls<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">ball_draw</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">paddle_draw</span><span class="token punctuation">(</span><span class="token keyword">const</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token function">fill_rectangle</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>clr<span class="token punctuation">,</span> g<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> g<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y<span class="token punctuation">,</span> g<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>width<span class="token punctuation">,</span> g<span class="token punctuation">.</span>paddle<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>In <code>draw_paddle</code>, we use the <code>fill_rectangle</code> function from SplashKit to draw the paddle based on its position, width, height, and color.</p>
<p><code>draw_ball</code> uses the <code>fill_circle</code> function to draw the ball based on its position, size, and color.</p>
<p><code>draw_block</code> uses the <code>fill_rectangle</code> function to draw a block based on its position, width, height, and color.</p>
<p><code>draw_terrain</code> iterates through the terrain grid and calls <code>draw_block</code> for each active block.</p>
<p>Now is a good time to talk about draw ordering; if you draw one thing, and then draw something else on the same frame which overlaps the first thing, the second thing will be drawn on top of the first thing. This is important to remember when drawing things like the paddle and the balls, as the balls should be drawn on top of the paddle. We draw the balls last in the <code>draw_global_state</code> function so that they are drawn on top of everything else as the player needs visibility of the balls to play the game.</p>
<p>You will also notice that after we clear the background we draw a rectangle which is slightly larger than the game area, this is to create a border around the game area which will help to visually separate the game area from the rest of the screen. We then draw a slightly smaller rectangle in the same position, in the color of the background to clear the game area, this is how we get a vertical border around the game area (as only the vertical edges of the second rectangle will be visible).</p>
<h1 id="finally-drawing">Finally drawing</h1>
<p>Now that we have our draw functions implemented, we can call them in the main game loop to draw the game entities on the screen.</p>
<p><strong>program.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"splashkit.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"globals.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"types.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_init.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_management.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"draw.h"</span>  </span>
  
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token punctuation">{</span>  
    <span class="token function">open_window</span><span class="token punctuation">(</span><span class="token string">"BreakIn"</span><span class="token punctuation">,</span> WINDOW_WIDTH<span class="token punctuation">,</span> WINDOW_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">hide_mouse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    GameState game <span class="token operator">=</span> <span class="token function">new_game_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">quit_requested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
        <span class="token function">process_events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token function">update_global_state</span><span class="token punctuation">(</span>game<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token function">draw_global_state</span><span class="token punctuation">(</span>game<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token function">refresh_screen</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token function">close_window</span><span class="token punctuation">(</span><span class="token string">"BreakIn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>If all has gone well you should see something like this:<br>
<img src="tutorial_assets/first_demo.png" alt="game screen"></p>
<p>Just one problem, we have no balls. Let’s fix that.</p>
<p><strong>program.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"splashkit.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"globals.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"types.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_init.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_management.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"draw.h"</span>  </span>
  
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token punctuation">{</span>  
    <span class="token function">open_window</span><span class="token punctuation">(</span><span class="token string">"BreakIn"</span><span class="token punctuation">,</span> WINDOW_WIDTH<span class="token punctuation">,</span> WINDOW_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">hide_mouse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    GameState game <span class="token operator">=</span> <span class="token function">new_game_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">quit_requested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
    <span class="token punctuation">{</span>  
        <span class="token function">process_events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mouse_clicked</span><span class="token punctuation">(</span>LEFT_BUTTON<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            game<span class="token punctuation">.</span>balls<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>  
                    <span class="token function">new_ball</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>rng<span class="token punctuation">.</span><span class="token function">randomInt</span><span class="token punctuation">(</span>GAME_AREA_START<span class="token punctuation">,</span> GAME_AREA_END<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
                              <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>GAME_AREA_HEIGHT <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> clr_ball_standard<span class="token punctuation">)</span>  
            <span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
        <span class="token function">update_global_state</span><span class="token punctuation">(</span>game<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token function">draw_global_state</span><span class="token punctuation">(</span>game<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token function">refresh_screen</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token function">close_window</span><span class="token punctuation">(</span><span class="token string">"BreakIn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>With any luck you now see something like this:</p>
<p><img src="tutorial_assets/first_demo.gif" alt="game screen"></p>
<h1 id="making-the-terrain-endless">Making the terrain endless</h1>
<p>Now that we have a basic game loop set up, we can start adding more features to the game. One of the first things we can do is make the terrain endless by adding a scrolling effect.</p>
<p>We also want to destroy any blocks that do not have a valid path to the top of the screen (they have been fully disconnected from the main terrain body).<br>
<img src="tutorial_assets/DFS.png" alt="endless terrain"></p>
<h3 id="dfs-culling">DFS Culling</h3>
<p>We will implement a Depth-First Search (DFS) algorithm to check if a block is connected to the top <code>Row</code> in our terrain. The DFS algorithm will start from the top row of the grid and traverse the terrain to find connected blocks. If a block is not connected to the top row, it will be deactivated.</p>
<p><strong>state_management.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token comment">// ...other declarations  </span>
  
<span class="token comment">/**  
 * @brief Count the number of non-empty rows in the terrain.  
 *  
 * @param g The game state.  
 * @return int The number of non-empty rows.  
 */</span>  
<span class="token keyword">int</span> <span class="token function">count_non_empty_rows</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token comment">/**  
 * @brief Shift the rows in the terrain down by the given number of rows.  
 *  
 * @param g The game state.  
 * @param num_rows_to_shift The number of rows to shift.  
 */</span>  
<span class="token keyword">void</span> <span class="token function">shift_rows_down</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">,</span> <span class="token keyword">int</span> num_rows_to_shift<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token comment">/**  
 * @brief Add a new chunk of terrain to the game.  
 *  
 * @param g The game state.  
 * @param num_rows The number of rows in the chunk.  
 */</span>  
<span class="token keyword">void</span> <span class="token function">add_new_chunk</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">,</span> <span class="token keyword">int</span> num_rows<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token comment">/**  
 * @brief Uses dfs_mark_reachable() to check if blocks are not connected to top row (have been shaved off main body of terrain)  
 * and deactivates them.  
 *  
 * @param g The game state.  
 */</span>  
<span class="token keyword">void</span> <span class="token function">deactivate_disconnected_clusters</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
<span class="token comment">/**  
 * @brief Uses DFS to mark blocks that are reachable from the top row.  
 *  
 * @param g The game state.  
 * @param row The row to start the search from.  
 * @param col The column to start the search from.  
 * @param visited The visited array.  
 */</span>  
<span class="token keyword">void</span> <span class="token function">dfs_mark_reachable</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">,</span> <span class="token keyword">int</span> row<span class="token punctuation">,</span> <span class="token keyword">int</span> col<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;&gt;</span><span class="token operator">&amp;</span> visited<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre>
<p>First declare this set of new functions in <code>state_management.h</code>.</p>
<p>And then define them in a new file:</p>
<p><strong>terrain_state.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">void</span> <span class="token function">dfs_mark_reachable</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">,</span> <span class="token keyword">int</span> row<span class="token punctuation">,</span> <span class="token keyword">int</span> col<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;&gt;</span><span class="token operator">&amp;</span> visited<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    std<span class="token operator">::</span>stack<span class="token operator">&lt;</span>std<span class="token operator">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> stack<span class="token punctuation">;</span>  
    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>row<span class="token punctuation">,</span> col<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">auto</span> pair <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">top</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">int</span> r <span class="token operator">=</span> pair<span class="token punctuation">.</span>first<span class="token punctuation">;</span>  
        <span class="token keyword">int</span> c <span class="token operator">=</span> pair<span class="token punctuation">.</span>second<span class="token punctuation">;</span>  
        stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> r <span class="token operator">&gt;=</span> g<span class="token punctuation">.</span>terrain<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> c <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> c <span class="token operator">&gt;=</span> g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">||</span> visited<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">continue</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
  
        visited<span class="token punctuation">[</span>r<span class="token punctuation">]</span><span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
  
        <span class="token comment">// Check adjacent blocks  </span>
        stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>r <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> c<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// above  </span>
        stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>r <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> c<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// below  </span>
        stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>r<span class="token punctuation">,</span> c <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// left  </span>
        stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>r<span class="token punctuation">,</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// right  </span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>This function uses a <a href="https://en.wikipedia.org/wiki/Depth-first_search">Depth-First Search (DFS)</a> algorithm to mark blocks that are reachable from the top row of the terrain. It starts from a given row and column position and traverses the terrain to find connected blocks.</p>
<p>The last argument is a reference to a 2D vector of boolean values called <code>visited</code>. This vector is used to keep track of visited blocks during the DFS traversal.</p>
<p>Once the function returns, the visited vector will be updated with the blocks that are reachable from the top row, and so we can refer to it to determine which blocks to deactivate.</p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">void</span> <span class="token function">deactivate_disconnected_clusters</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;&gt;</span> <span class="token function">visited</span><span class="token punctuation">(</span>NUM_ROWS<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>NUM_COLS<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token comment">// Mark all reachable blocks starting from the top row  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> col <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> col <span class="token operator">&lt;</span> NUM_COLS<span class="token punctuation">;</span> <span class="token operator">++</span>col<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token function">dfs_mark_reachable</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> col<span class="token punctuation">,</span> visited<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token comment">// Deactivate all unvisited (disconnected) blocks  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> row <span class="token operator">&lt;</span> NUM_ROWS<span class="token punctuation">;</span> <span class="token operator">++</span>row<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> col <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> col <span class="token operator">&lt;</span> NUM_COLS<span class="token punctuation">;</span> <span class="token operator">++</span>col<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span>g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>visited<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>This function calls our DFS and then deactivates any blocks which were not visited during the traversal.</p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">int</span> <span class="token function">count_non_empty_rows</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">int</span> non_empty_rows <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> row <span class="token operator">:</span> g<span class="token punctuation">.</span>terrain<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">any_of</span><span class="token punctuation">(</span>row<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> row<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Block<span class="token operator">&gt;</span><span class="token operator">&amp;</span> block<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> block <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token operator">++</span>non_empty_rows<span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">return</span> non_empty_rows<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">shift_rows_down</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">,</span> <span class="token keyword">int</span> num_rows_to_shift<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_rows_to_shift <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  
  
    <span class="token comment">// Shift rows down  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> g<span class="token punctuation">.</span>terrain<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> y <span class="token operator">&gt;=</span> num_rows_to_shift<span class="token punctuation">;</span> <span class="token operator">--</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span>y <span class="token operator">-</span> num_rows_to_shift<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>block <span class="token operator">:</span> g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token comment">// block-&gt;target_pos.y += BLOCK_HEIGHT * num_rows_to_shift;  </span>
                block<span class="token operator">-</span><span class="token operator">&gt;</span>pos<span class="token punctuation">.</span>y <span class="token operator">+</span><span class="token operator">=</span> BLOCK_HEIGHT <span class="token operator">*</span> num_rows_to_shift<span class="token punctuation">;</span>  
                block<span class="token operator">-</span><span class="token operator">&gt;</span>grid_pos<span class="token punctuation">.</span>y <span class="token operator">+</span><span class="token operator">=</span> num_rows_to_shift<span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment">// Clear the top rows  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> num_rows_to_shift<span class="token punctuation">;</span> <span class="token operator">++</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>block <span class="token operator">:</span> g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            block<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Set each element to nullptr  </span>
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>These functions are used to count the number of non-empty rows in the terrain and shift the rows down by a given number of rows.</p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">void</span> <span class="token function">add_new_chunk</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">,</span> <span class="token keyword">int</span> num_rows<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token comment">// Add new rows at the top  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> num_rows<span class="token punctuation">;</span> <span class="token operator">++</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        Row new_row<span class="token punctuation">;</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> NUM_COLS<span class="token punctuation">;</span> <span class="token operator">++</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            point_2d pos <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>TERRAIN_OFFSET <span class="token operator">+</span> x <span class="token operator">*</span> BLOCK_WIDTH<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>y <span class="token operator">*</span> BLOCK_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  
            <span class="token comment">// point_2d target_pos = {pos.x, static_cast&lt;double&gt;(y * BLOCK_HEIGHT)};  </span>
            ivec2 grid_pos <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">,</span> y<span class="token punctuation">}</span><span class="token punctuation">;</span>  
            new_row<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>Block<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">new_block</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> grid_pos<span class="token punctuation">,</span> BLOCK_WIDTH<span class="token punctuation">,</span> BLOCK_HEIGHT<span class="token punctuation">,</span> clr_block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
        g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>new_row<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>Finally, this function adds a new chunk of terrain to the game by creating new rows at the top of the terrain grid after we shift the remaining rows down.</p>
<p>Once we have added these functions to our new source file, we will remove <code>update_terrain</code> from <code>block_state.cpp</code> and redefine it in <code>terrain_state.cpp</code> as follows:</p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_management.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"globals.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_init.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stack&gt;</span>  </span>
  
<span class="token comment">// ..other definitions  </span>
  
<span class="token keyword">void</span> <span class="token function">update_terrain</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token comment">// Check if the bottom row is completely empty  </span>
    <span class="token comment">// if it isn't then we don't need to shift or add any blocks  </span>
    <span class="token keyword">bool</span> bottom_row_empty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> block <span class="token operator">:</span> g<span class="token punctuation">.</span>terrain<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            bottom_row_empty <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
            <span class="token keyword">break</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token comment">// Shift rows down and add new rows at the top if the bottom row is empty  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bottom_row_empty<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">int</span> non_empty_rows <span class="token operator">=</span> <span class="token function">count_non_empty_rows</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">int</span> num_rows_to_shift <span class="token operator">=</span> NUM_ROWS <span class="token operator">-</span> non_empty_rows<span class="token punctuation">;</span>  
  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>num_rows_to_shift <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token function">shift_rows_down</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> num_rows_to_shift<span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token function">add_new_chunk</span><span class="token punctuation">(</span>g<span class="token punctuation">,</span> num_rows_to_shift<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token comment">// Deactivate disconnected clusters  </span>
    <span class="token function">deactivate_disconnected_clusters</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
    <span class="token comment">// Update each block  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> row <span class="token operator">:</span> g<span class="token punctuation">.</span>terrain<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> block <span class="token operator">:</span> row<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                <span class="token function">block_update</span><span class="token punctuation">(</span><span class="token operator">*</span>block<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>block<span class="token operator">-</span><span class="token operator">&gt;</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                    block<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Automatically deletes the block and sets the pointer to nullptr  </span>
                <span class="token punctuation">}</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>With any luck your terrain is now behaving like this as rows are cleared (ignore my debug mouse destruction):</p>
<p><img src="tutorial_assets/cull.gif" alt="endless terrain"></p>
<h3 id="velocity-and-making-it-feel-nice">Velocity and making it feel nice</h3>
<p>This is cool but it’s a bit jarring when the terrain shifts, let’s add a little animation to make it feel a bit smoother.</p>
<p>To do this, we’re going to give blocks 2 new properties:</p>
<p><code>block.target_pos</code> - the screen position we want the block to land at.</p>
<p><code>block.y_vel</code> - the speed at which the block is moving towards its target position (blocks will only shift vertically so we only need a y velocity).</p>
<p><strong>types.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">struct</span> Block <span class="token punctuation">{</span>  
    <span class="token keyword">bool</span> active<span class="token punctuation">;</span>  
    point_2d pos<span class="token punctuation">;</span>  
    point_2d target_pos<span class="token punctuation">;</span>  
    ivec2 grid_pos<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> width<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> height<span class="token punctuation">;</span>  
    color clr<span class="token punctuation">;</span>  
    <span class="token keyword">float</span> y_vel<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
<p><strong>state_init.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp">Block <span class="token function">new_block</span><span class="token punctuation">(</span>point_2d pos<span class="token punctuation">,</span> point_2d target_pos<span class="token punctuation">,</span> ivec2 grid_pos<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> color c<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre>
<p><strong>state_init.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp">Block <span class="token function">new_block</span><span class="token punctuation">(</span>point_2d pos<span class="token punctuation">,</span> point_2d target_pos<span class="token punctuation">,</span> ivec2 grid_pos<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">,</span> color c<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    Block block<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>pos <span class="token operator">=</span> pos<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>target_pos <span class="token operator">=</span> target_pos<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>grid_pos <span class="token operator">=</span> grid_pos<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>clr <span class="token operator">=</span> c<span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
    block<span class="token punctuation">.</span>y_vel <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>  
    <span class="token keyword">return</span> block<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
Grid <span class="token function">new_grid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    Grid grid<span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> NUM_ROWS<span class="token punctuation">;</span> <span class="token operator">++</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        Row row<span class="token punctuation">;</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> NUM_COLS<span class="token punctuation">;</span> <span class="token operator">++</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            point_2d pos <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>TERRAIN_OFFSET <span class="token operator">+</span> x <span class="token operator">*</span> BLOCK_WIDTH<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>y <span class="token operator">*</span> BLOCK_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  
            ivec2 grid_pos <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">,</span> y<span class="token punctuation">}</span><span class="token punctuation">;</span>  
            row<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>Block<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">new_block</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> grid_pos<span class="token punctuation">,</span> BLOCK_WIDTH<span class="token punctuation">,</span> BLOCK_HEIGHT<span class="token punctuation">,</span> clr_block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
        grid<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>row<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">return</span> grid<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>When creating a new block, we now need to provide both the initial position (<code>pos</code>) and the target position (<code>target_pos</code>).</p>
<p>In the <code>new_grid</code> function we need to set the <code>target_pos</code> of each block to match its initial position.</p>
<p><strong>block_state.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">void</span> <span class="token function">block_update</span><span class="token punctuation">(</span>Block<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>b<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">return</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token comment">// Move the block towards its target position  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>target_pos<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        b<span class="token punctuation">.</span>y_vel <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">0.1f</span><span class="token punctuation">;</span> <span class="token comment">// Increase the vertical velocity  </span>
        b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">+</span><span class="token operator">=</span> b<span class="token punctuation">.</span>y_vel<span class="token punctuation">;</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">&gt;=</span> b<span class="token punctuation">.</span>target_pos<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">=</span> b<span class="token punctuation">.</span>target_pos<span class="token punctuation">.</span>y<span class="token punctuation">;</span>  
            b<span class="token punctuation">.</span>y_vel <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span> <span class="token comment">// Reset the vertical velocity when the block reaches its target position  </span>
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>In the <code>block_update</code> function, we update the block’s position based on its target position and vertical velocity. The block moves towards its target position by increasing its vertical velocity until it reaches the target position.</p>
<p>Finally:</p>
<p><strong>terrain_state.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">void</span> <span class="token function">shift_rows_down</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">,</span> <span class="token keyword">int</span> num_rows_to_shift<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_rows_to_shift <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>  
  
    <span class="token comment">// Shift rows down  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> g<span class="token punctuation">.</span>terrain<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> y <span class="token operator">&gt;=</span> num_rows_to_shift<span class="token punctuation">;</span> <span class="token operator">--</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span>y <span class="token operator">-</span> num_rows_to_shift<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>block <span class="token operator">:</span> g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
                block<span class="token operator">-</span><span class="token operator">&gt;</span>target_pos<span class="token punctuation">.</span>y <span class="token operator">+</span><span class="token operator">=</span> BLOCK_HEIGHT <span class="token operator">*</span> num_rows_to_shift<span class="token punctuation">;</span>  
                block<span class="token operator">-</span><span class="token operator">&gt;</span>grid_pos<span class="token punctuation">.</span>y <span class="token operator">+</span><span class="token operator">=</span> num_rows_to_shift<span class="token punctuation">;</span>  
            <span class="token punctuation">}</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
    <span class="token comment">// Clear the top rows  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> num_rows_to_shift<span class="token punctuation">;</span> <span class="token operator">++</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>block <span class="token operator">:</span> g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            block<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Set each element to nullptr  </span>
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">add_new_chunk</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">,</span> <span class="token keyword">int</span> num_rows<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token comment">// Add new rows at the top  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> num_rows<span class="token punctuation">;</span> <span class="token operator">++</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        Row new_row<span class="token punctuation">;</span>  
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> NUM_COLS<span class="token punctuation">;</span> <span class="token operator">++</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            point_2d pos <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>TERRAIN_OFFSET <span class="token operator">+</span> x <span class="token operator">*</span> BLOCK_WIDTH<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  
            point_2d target_pos <span class="token operator">=</span> <span class="token punctuation">{</span>pos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>y <span class="token operator">*</span> BLOCK_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  
            ivec2 grid_pos <span class="token operator">=</span> <span class="token punctuation">{</span>x<span class="token punctuation">,</span> y<span class="token punctuation">}</span><span class="token punctuation">;</span>  
            new_row<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>Block<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function">new_block</span><span class="token punctuation">(</span>pos<span class="token punctuation">,</span> target_pos<span class="token punctuation">,</span> grid_pos<span class="token punctuation">,</span> BLOCK_WIDTH<span class="token punctuation">,</span> BLOCK_HEIGHT<span class="token punctuation">,</span> clr_block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
        g<span class="token punctuation">.</span>terrain<span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>new_row<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>In <code>add_new_chunk</code> we set the initial <code>pos.y</code> of each block to 0 and the <code>target_pos.y</code> to the row number multiplied by the block height. This will make the blocks appear to slide down from the top of the screen when they are added to the terrain.</p>
<p>in <code>shift_rows_down</code> we no longer set the <code>pos.y</code> of each block to the target position, instead we increase the <code>target_pos.y</code> by the block height multiplied by the number of rows to shift. This will make the blocks slide down to their new positions when the terrain is shifted.</p>
<p>Your terrain should now be moving like this as we cull it:</p>
<p><img src="tutorial_assets/block_vel.gif" alt="smooth terrain"></p>
<p>This is starting to feel okay - let’s add some more juice.</p>
<h1 id="particles">Particles</h1>
<p>We’re going to add some particles to the game to make it feel more dynamic and exciting. We’ll create a new particle type and implement a particle system against the <code>GameState</code> to manage the particles.</p>
<p><strong>note:</strong> implementing particles on the cpu like this is generally not a great pattern; it’s slow and not very scalable. For a computationally intense game you would want to use the GPU to handle particles, but for our purposes this is fine.<br>
We will simply ensure we don’t create too many and that they are culled quickly.</p>
<h3 id="particle-type">Particle Type</h3>
<p>In <code>types.h</code> add a new struct for the particle type and extend <code>GameState</code> to store some particles:</p>
<p><strong>types.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">struct</span> Particle <span class="token punctuation">{</span>  
    point_2d pos<span class="token punctuation">;</span>  
    vector_2d vel<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>  
    color clr<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> ttl<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> max_ttl<span class="token punctuation">;</span>  
    <span class="token keyword">int</span> original_size<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
  
<span class="token keyword">struct</span> GameState <span class="token punctuation">{</span>  
    <span class="token keyword">int</span> score<span class="token punctuation">;</span>  
    GameStatus game_status<span class="token punctuation">;</span>  
    Paddle paddle<span class="token punctuation">;</span>  
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Ball<span class="token operator">&gt;</span> balls<span class="token punctuation">;</span>  
    Grid terrain<span class="token punctuation">;</span>  
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Particle<span class="token operator">&gt;</span> particles<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
<p><code>ttl</code> is how many frames the particle should exist for, it is decremented each frame.</p>
<p><code>max_ttl</code> is the initial ttl value, we will use this to determine the particle’s alpha value based on how long it has been alive.</p>
<p><code>original_size</code> is the initial size of the particle, we will <strong>can</strong> use this to determine the particle’s size based on how long it has been alive.</p>
<p>In <code>state_init.h</code> add a function to create a new particle:</p>
<p><strong>state_init.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp">Particle <span class="token function">new_particle</span><span class="token punctuation">(</span>point_2d pos<span class="token punctuation">,</span> vector_2d vel<span class="token punctuation">,</span> color clr<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> ttl<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre>
<p>And in <code>state_init.cpp</code> implement this function:</p>
<p><strong>state_init.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp">Particle <span class="token function">new_particle</span><span class="token punctuation">(</span>point_2d pos<span class="token punctuation">,</span> vector_2d vel<span class="token punctuation">,</span> color clr<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> ttl<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    Particle particle<span class="token punctuation">;</span>  
    particle<span class="token punctuation">.</span>pos <span class="token operator">=</span> pos<span class="token punctuation">;</span>  
    particle<span class="token punctuation">.</span>vel <span class="token operator">=</span> vel<span class="token punctuation">;</span>  
    particle<span class="token punctuation">.</span>size <span class="token operator">=</span> size<span class="token punctuation">;</span>  
    particle<span class="token punctuation">.</span>clr <span class="token operator">=</span> clr<span class="token punctuation">;</span>  
    particle<span class="token punctuation">.</span>ttl <span class="token operator">=</span> ttl<span class="token punctuation">;</span>  
    particle<span class="token punctuation">.</span>max_ttl <span class="token operator">=</span> ttl<span class="token punctuation">;</span>  
    particle<span class="token punctuation">.</span>original_size <span class="token operator">=</span> size<span class="token punctuation">;</span>  
    <span class="token keyword">return</span> particle<span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>In <code>state_management.h</code> declare functions to update the particles:</p>
<p><strong>state_management.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">void</span> <span class="token function">particle_update</span><span class="token punctuation">(</span>Particle<span class="token operator">&amp;</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">void</span> <span class="token function">update_particles</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre>
<p>And in a new file - <code>particle_state.cpp</code> - implement these functions:</p>
<p><strong>particle_state.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_management.h"</span>  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"globals.h"</span>  </span>
  
<span class="token keyword">void</span> <span class="token function">particle_update</span><span class="token punctuation">(</span>Particle<span class="token operator">&amp;</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    p<span class="token punctuation">.</span>vel<span class="token punctuation">.</span>y <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">;</span>  
    p<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x <span class="token operator">+</span><span class="token operator">=</span> p<span class="token punctuation">.</span>vel<span class="token punctuation">.</span>x<span class="token punctuation">;</span>  
    p<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">+</span><span class="token operator">=</span> p<span class="token punctuation">.</span>vel<span class="token punctuation">.</span>y<span class="token punctuation">;</span>  
    p<span class="token punctuation">.</span>ttl<span class="token operator">--</span><span class="token punctuation">;</span>  
  
    <span class="token comment">// Increase opacity based on the remaining ttl  </span>
    <span class="token keyword">float</span> alpha <span class="token operator">=</span> <span class="token number">1.0f</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>ttl<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>max_ttl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    p<span class="token punctuation">.</span>clr<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint8_t<span class="token operator">&gt;</span><span class="token punctuation">(</span>alpha <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// Decrease size based on the remaining ttl  </span>
    p<span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>original_size <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0f</span> <span class="token operator">-</span> <span class="token punctuation">(</span>alpha<span class="token operator">/</span><span class="token number">2.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">update_particles</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> p <span class="token operator">:</span> g<span class="token punctuation">.</span>particles<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">particle_update</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token comment">// Remove dead particles  </span>
    g<span class="token punctuation">.</span>particles<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">remove_if</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>particles<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>particles<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
                                     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> Particle<span class="token operator">&amp;</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> p<span class="token punctuation">.</span>ttl <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> p<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">&gt;</span> WINDOW_HEIGHT<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
                      g<span class="token punctuation">.</span>particles<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>In <code>particle_update</code> we update the particle’s position based on its velocity and decrease its ttl. We also adjust the particle’s alpha value and size based on the remaining ttl.</p>
<p>By setting the velocity increase per frame to be quite large, and culling the particles once they reach the bottom of the screen, we can help address performance concerns.</p>
<p>The other condition to cull particles is if their ttl reaches 0 (at which point they should be fully transparent).</p>
<h3 id="drawing-particles">Drawing Particles</h3>
<p>In <code>draw.h</code> declare functions to draw the particles:</p>
<p><strong>draw.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">void</span> <span class="token function">particle_draw</span><span class="token punctuation">(</span><span class="token keyword">const</span> Particle<span class="token operator">&amp;</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">void</span> <span class="token function">draw_particles</span><span class="token punctuation">(</span><span class="token keyword">const</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre>
<p>And in <code>draw.cpp</code> implement these functions:</p>
<p><strong>draw.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">void</span> <span class="token function">particle_draw</span><span class="token punctuation">(</span><span class="token keyword">const</span> Particle<span class="token operator">&amp;</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token function">fill_circle</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>clr<span class="token punctuation">,</span> p<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y<span class="token punctuation">,</span> p<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
  
  
<span class="token keyword">void</span> <span class="token function">draw_particles</span><span class="token punctuation">(</span><span class="token keyword">const</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> p <span class="token operator">:</span> g<span class="token punctuation">.</span>particles<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">particle_draw</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>This is the same pattern we are using to update and draw all our other types!</p>
<h3 id="spawning-particles">Spawning Particles</h3>
<p>There are a lot of instances where we can use particles to add some visual flair and feedback to the game, for now let’s just create some when a block is destroyed:</p>
<p><strong>state_management.h</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">void</span> <span class="token function">block_destroy</span><span class="token punctuation">(</span><span class="token keyword">const</span> Block<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre>
<p>Remember when we said we could use the <code>active</code> property to stop objects being drawn or updated but still access their properties? This is where that comes in handy.</p>
<p><strong>block_state.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token comment">//.. other includes  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"state_init.h"</span>  </span>
  
<span class="token keyword">void</span> <span class="token function">block_update</span><span class="token punctuation">(</span>Block<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>b<span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        <span class="token function">block_destroy</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">return</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
  
    <span class="token comment">// Move the block towards its target position  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>target_pos<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        b<span class="token punctuation">.</span>y_vel <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">0.1f</span><span class="token punctuation">;</span> <span class="token comment">// Increase the vertical velocity  </span>
        b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">+</span><span class="token operator">=</span> b<span class="token punctuation">.</span>y_vel<span class="token punctuation">;</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">&gt;=</span> b<span class="token punctuation">.</span>target_pos<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
            b<span class="token punctuation">.</span>pos<span class="token punctuation">.</span>y <span class="token operator">=</span> b<span class="token punctuation">.</span>target_pos<span class="token punctuation">.</span>y<span class="token punctuation">;</span>  
            b<span class="token punctuation">.</span>y_vel <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span> <span class="token comment">// Reset the vertical velocity when the block reaches its target position  </span>
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
  
<span class="token keyword">void</span> <span class="token function">block_destroy</span><span class="token punctuation">(</span><span class="token keyword">const</span> Block<span class="token operator">&amp;</span> b<span class="token punctuation">,</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token operator">++</span>g<span class="token punctuation">.</span>score<span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
        vector_2d particle_vel <span class="token operator">=</span> <span class="token punctuation">{</span>rng<span class="token punctuation">.</span><span class="token function">randomFloat</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2.0f</span><span class="token punctuation">,</span> <span class="token number">2.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rng<span class="token punctuation">.</span><span class="token function">randomFloat</span><span class="token punctuation">(</span><span class="token number">2.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// can't have upward trajectory  </span>
        g<span class="token punctuation">.</span>particles<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token function">new_particle</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>pos<span class="token punctuation">,</span> particle_vel<span class="token punctuation">,</span> b<span class="token punctuation">.</span>clr<span class="token punctuation">,</span> rng<span class="token punctuation">.</span><span class="token function">randomInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>Instead of simply returning when a block is not active, we now call <code>block_destroy</code> which increments the player’s score and creates 2 particles at the block’s position with random velocities and sizes.</p>
<p>Remember to remove the score increment from <code>ball_check_block_collision</code> in <code>ball_state.cpp</code> as we are now incrementing the score when a block is destroyed (which means we can easily add <code>hitpoints</code> etc to blocks now without messing up our scoring logic).</p>
<p>Finally - we need to update and draw the particles in the main game loop:</p>
<p><strong>global_state.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">void</span> <span class="token function">update_global_state</span><span class="token punctuation">(</span>GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token function">update_particles</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">paddle_update</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">update_balls</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">update_terrain</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p><strong>draw.cpp</strong></p>
<pre class=" language-cpp"><code class="prism  language-cpp"><span class="token keyword">void</span> <span class="token function">draw_global_state</span><span class="token punctuation">(</span><span class="token keyword">const</span> GameState<span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token function">clear_screen</span><span class="token punctuation">(</span>clr_background<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">fill_rectangle</span><span class="token punctuation">(</span><span class="token function">color_from_hex</span><span class="token punctuation">(</span><span class="token string">"#FBF6E0"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GAME_AREA_START <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GAME_AREA_WIDTH <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">,</span> GAME_AREA_HEIGHT <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">fill_rectangle</span><span class="token punctuation">(</span>clr_background<span class="token punctuation">,</span> GAME_AREA_START<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> GAME_AREA_WIDTH<span class="token punctuation">,</span> GAME_AREA_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">draw_text</span><span class="token punctuation">(</span><span class="token string">"score: "</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>score<span class="token punctuation">)</span><span class="token punctuation">,</span> COLOR_WHITE<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token function">option_to_screen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">draw_particles</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">draw_terrain</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">paddle_draw</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">draw_balls</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  
</code></pre>
<p>And now we should be looking half decent:</p>
<p><img src="tutorial_assets/particle.gif" alt="particles"></p>
</div>
</body>

</html>
